---
phase: 06-automation-safety
plan: 06
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - frontend/src/api/staging.ts
  - frontend/src/api/audit.ts
  - frontend/src/hooks/useStaging.ts
  - frontend/src/hooks/useAudit.ts
  - frontend/src/pages/StagingPage.tsx
  - frontend/src/pages/AuditLogPage.tsx
  - frontend/src/components/layout/AppSidebar.tsx
  - frontend/src/App.tsx
autonomous: true
requirements: [PAGE-04, PAGE-05]

must_haves:
  truths:
    - "Staging page shows countdown timers for each staged email"
    - "User can rescue individual or batch-rescue staged emails"
    - "Audit log page shows filterable history with undo button per row"
    - "Staging count badge appears in navigation"
  artifacts:
    - path: "frontend/src/pages/StagingPage.tsx"
      provides: "Staging page with countdown timers and rescue actions"
      contains: "useCountdown"
    - path: "frontend/src/pages/AuditLogPage.tsx"
      provides: "Audit log page with filters and undo"
      contains: "undoAction"
    - path: "frontend/src/api/staging.ts"
      provides: "Staging API client"
      exports: ["fetchStagedEmails", "fetchStagingCount", "rescueStagedEmail", "batchRescueStagedEmails"]
    - path: "frontend/src/api/audit.ts"
      provides: "Audit API client"
      exports: ["fetchAuditLogs", "undoAuditAction"]
  key_links:
    - from: "frontend/src/pages/StagingPage.tsx"
      to: "/api/staging"
      via: "TanStack Query hooks"
      pattern: "useStaging"
    - from: "frontend/src/pages/AuditLogPage.tsx"
      to: "/api/audit"
      via: "TanStack Query hooks"
      pattern: "useAudit"
    - from: "frontend/src/App.tsx"
      to: "StagingPage and AuditLogPage"
      via: "routes /staging and /audit"
      pattern: "StagingPage|AuditLogPage"
---

<objective>
Build the Staging page with countdown timers and rescue actions, and the Audit Log page with filterable history and undo capability -- plus staging count badge in navigation.

Purpose: Users need to see emails in staging (with time remaining before execution), rescue emails they want to keep, review all automated action history, and undo past actions. The staging badge in navigation ensures users don't miss important staging items.

Output: Staging page, Audit Log page, API clients, hooks, and navigation badge.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-automation-safety/06-RESEARCH.md
@.planning/phases/06-automation-safety/06-03-SUMMARY.md

@frontend/src/App.tsx
@frontend/src/components/layout/AppSidebar.tsx
@frontend/src/lib/constants.ts
@frontend/src/api/patterns.ts
@frontend/src/hooks/usePatterns.ts
@frontend/src/hooks/useSocket.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Staging page with countdown timers and rescue</name>
  <files>
    frontend/src/api/staging.ts
    frontend/src/hooks/useStaging.ts
    frontend/src/pages/StagingPage.tsx
    frontend/src/components/layout/AppSidebar.tsx
    frontend/src/lib/constants.ts
    frontend/src/hooks/useSocket.ts
  </files>
  <action>
    **1. Create `frontend/src/api/staging.ts`:**
    - Import `apiFetch` from `./client`
    - Define `StagedEmail` interface: id, messageId, originalFolder, stagedAt, expiresAt, status, actions (array), ruleId, mailboxId, createdAt
    - Define `StagingResponse` = `{ stagedEmails: StagedEmail[]; pagination }`

    Export:
    - `fetchStagedEmails(params: { mailboxId?, status?, page?, limit? }): Promise<StagingResponse>`
    - `fetchStagingCount(mailboxId?: string): Promise<{ count: number }>` -- GET /api/staging/count
    - `rescueStagedEmail(id: string): Promise<{ stagedEmail: StagedEmail }>` -- POST /api/staging/:id/rescue
    - `batchRescueStagedEmails(ids: string[]): Promise<{ rescued: number }>` -- POST /api/staging/batch-rescue

    **2. Create `frontend/src/hooks/useStaging.ts`:**
    - Import hooks from TanStack Query, API functions, useUIStore
    - `useStaging(params?)` -- useQuery ['staging', params]
    - `useStagingCount()` -- useQuery ['staging-count'] with refetchInterval: 60000 (refresh every minute for badge)
    - `useRescueStagedEmail()` -- useMutation, invalidates ['staging', 'staging-count']
    - `useBatchRescue()` -- useMutation, invalidates ['staging', 'staging-count']

    **3. Create `frontend/src/pages/StagingPage.tsx`:**
    - Import hooks, shadcn components (Card, Button, Badge, Checkbox, Table, TableHeader, TableRow, TableCell, TableBody)
    - Import `formatDistanceToNow` from `date-fns` for countdown display

    **useCountdown hook (inline in file):**
    - `useCountdown(expiresAt: string): string` -- returns remaining time as "Xh Ym" or "Expired"
    - Uses `useState` + `useEffect` with `setInterval(update, 60000)` to update every minute
    - Calculate: `ms = new Date(expiresAt).getTime() - Date.now()`, format hours/minutes
    - Color coding: green if >12h, yellow if 4-12h, red if <4h, gray if expired

    **StagedEmailRow component (inline):**
    - Props: `{ email: StagedEmail; selected: boolean; onSelect; onRescue }`
    - Show: checkbox | message ID (truncated) | original folder | actions badges | countdown timer | rescue button
    - Countdown timer with color-coded badge using useCountdown
    - Rescue button (lifesaver icon) triggers onRescue

    **StagingPage component:**
    - Per-mailbox filter using selectedMailboxId from UI store
    - Table layout with StagedEmailRow for each staged email
    - Batch rescue: checkbox selection + "Rescue Selected" button
    - Count badge in header showing total staged
    - Empty state: "No emails in staging. When automation rules match destructive actions, emails will appear here for review."
    - Pagination at bottom
    - Loading state

    **4. Add staging count badge to navigation:**
    - Update `frontend/src/components/layout/AppSidebar.tsx`:
      - Import `useStagingCount` hook
      - For the Staging nav item, show a badge with count next to the label if count > 0
      - Badge should be a small red/orange circle with the number (shadcn Badge component with variant="destructive")
    - Update `frontend/src/lib/constants.ts` if the NAV_ITEMS array needs modification to support badge rendering

    **5. Add Socket.IO listener for staging events:**
    - Update `frontend/src/hooks/useSocket.ts`:
      - Listen for `staging:new` event
      - On receive, invalidate `['staging-count']` and `['staging']` queries via queryClient
      - This ensures the badge and staging page update in real-time when a new email enters staging
  </action>
  <verify>
    Run `npx tsc --noEmit` from frontend directory.
    Verify StagingPage.tsx exists with useCountdown hook.
    Verify AppSidebar.tsx shows staging count badge.
    Verify useSocket.ts handles staging:new event.
  </verify>
  <done>
    Staging page shows all staged emails with live countdown timers.
    Individual rescue and batch rescue supported.
    Staging count badge visible in sidebar navigation.
    Socket.IO real-time updates when emails enter staging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit log page with filters and undo, update App routes</name>
  <files>
    frontend/src/api/audit.ts
    frontend/src/hooks/useAudit.ts
    frontend/src/pages/AuditLogPage.tsx
    frontend/src/App.tsx
  </files>
  <action>
    **1. Create `frontend/src/api/audit.ts`:**
    - Import `apiFetch` from `./client`
    - Define `AuditLogEntry` interface: id, userId, mailboxId, action, targetType, targetId, details (Record), undoable, undoneAt, undoneBy, createdAt
    - Define `AuditResponse` = `{ auditLogs: AuditLogEntry[]; pagination }`

    Export:
    - `fetchAuditLogs(params: { mailboxId?, ruleId?, action?, startDate?, endDate?, page?, limit? }): Promise<AuditResponse>`
    - `undoAuditAction(id: string): Promise<{ auditLog: AuditLogEntry }>` -- POST /api/audit/:id/undo

    **2. Create `frontend/src/hooks/useAudit.ts`:**
    - `useAudit(params?)` -- useQuery ['audit', params]
    - `useUndoAction()` -- useMutation calling undoAuditAction, invalidates ['audit'] on success

    **3. Create `frontend/src/pages/AuditLogPage.tsx`:**
    - Import hooks, shadcn components (Table, Button, Badge, Select, Input for date range, Card)
    - Import `format, formatDistanceToNow` from `date-fns`

    **Filters section:**
    - Mailbox filter: dropdown using selectedMailboxId or "All mailboxes"
    - Action type filter: multi-select or dropdown with options from AuditAction type (rule_created, rule_executed, email_staged, email_rescued, email_executed, pattern_approved, pattern_rejected, undo_action, whitelist_updated, etc.)
    - Date range: start date + end date inputs (type="date")
    - Rule filter: optional text input for rule ID filtering
    - "Clear filters" button

    **AuditRow component (inline):**
    - Columns: Timestamp | Action (as badge with color coding) | Target | Details summary | Undo button
    - Action badge colors: rule_created=blue, rule_executed=green, email_staged=yellow, email_rescued=cyan, email_executed=orange, undo_action=purple, whitelist_updated=gray
    - Details summary: brief human-readable description based on action type and details object (e.g., "Moved email from sender@email.com to Archive")
    - Undo button: shown only if `undoable === true && !undoneAt && createdAt is within 48h`
    - If undoneAt is set, show "Undone" badge instead of button
    - Timestamp: show relative time ("2 hours ago") with full timestamp on hover (title attribute)

    **AuditLogPage layout:**
    - Page header: "Audit Log" title
    - Filters section at top
    - Table with AuditRow for each entry
    - Pagination at bottom
    - Empty state: "No audit entries yet. Automated actions and rule changes will appear here."
    - Loading state

    **4. Update `frontend/src/App.tsx`:**
    - Import `StagingPage` from `@/pages/StagingPage`
    - Import `AuditLogPage` from `@/pages/AuditLogPage`
    - Replace `<ComingSoonPage title="Staging" />` with `<StagingPage />`
    - Replace `<ComingSoonPage title="Audit Log" />` with `<AuditLogPage />`
    - Keep route paths as `/staging` and `/audit`
    - If ComingSoonPage is no longer used by any route (check /settings), keep the import for /settings. If /settings still uses it, leave the import.
  </action>
  <verify>
    Run `npx tsc --noEmit` from frontend directory.
    Verify AuditLogPage.tsx exists with filter controls and undo buttons.
    Verify App.tsx routes /staging to StagingPage and /audit to AuditLogPage.
    Verify undo button only shows for undoable entries within 48h that haven't been undone.
  </verify>
  <done>
    Audit log page shows filterable history by mailbox, action type, and date range.
    Undo button appears on eligible rows (undoable, within 48h, not already undone).
    Staging page and Audit log page replace their ComingSoonPage placeholders.
    All three Phase 6 pages (Rules, Staging, Audit) are now live in the app.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes from frontend/
- StagingPage and AuditLogPage exist with correct features
- App.tsx routes /staging and /audit to real pages
- Staging count badge visible in AppSidebar
- Socket.IO staging:new event handled for real-time updates
- Undo button logic correct (undoable + within 48h + not already undone)
</verification>

<success_criteria>
- Staging page shows countdown timers, rescue, and batch rescue
- Audit log page shows filterable history with undo per row
- Navigation staging badge shows count of active staged items
- Socket.IO pushes staging notifications in real-time
- All three ComingSoonPage placeholders replaced with real pages
</success_criteria>

<output>
After completion, create `.planning/phases/06-automation-safety/06-06-SUMMARY.md`
</output>
