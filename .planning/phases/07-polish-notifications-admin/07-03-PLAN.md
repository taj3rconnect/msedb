---
phase: 07-polish-notifications-admin
plan: 03
type: execute
wave: 3
depends_on: ["07-01", "07-02"]
files_modified:
  - frontend/src/api/admin.ts
  - frontend/src/hooks/useAdmin.ts
  - frontend/src/components/admin/UserManagement.tsx
  - frontend/src/components/admin/OrgRulesSection.tsx
  - frontend/src/components/admin/AnalyticsSection.tsx
  - frontend/src/components/admin/SystemHealthSection.tsx
  - frontend/src/pages/AdminPage.tsx
  - frontend/src/App.tsx
  - frontend/src/lib/constants.ts
  - frontend/src/components/layout/AppSidebar.tsx
autonomous: true
requirements:
  - PAGE-07

must_haves:
  truths:
    - "Admin can access the Admin Panel page via sidebar navigation"
    - "Non-admin users cannot see the Admin nav item or access the /admin route"
    - "Admin can invite new users by email and assign roles"
    - "Admin can deactivate users and change roles"
    - "Admin can create and delete org-wide rules"
    - "Admin can view aggregate analytics (total users, events, rules, patterns)"
    - "Admin can view per-mailbox webhook status and per-user token health"
  artifacts:
    - path: "frontend/src/pages/AdminPage.tsx"
      provides: "Admin panel with tabbed sections"
      exports: ["AdminPage"]
    - path: "frontend/src/api/admin.ts"
      provides: "Admin API client functions"
      exports: ["fetchAnalytics", "fetchSystemHealth", "fetchOrgRules", "createOrgRule", "deleteOrgRule"]
    - path: "frontend/src/hooks/useAdmin.ts"
      provides: "TanStack Query hooks for admin data"
      exports: ["useAdminAnalytics", "useSystemHealth", "useAdminUsers", "useOrgRules"]
    - path: "frontend/src/components/admin/UserManagement.tsx"
      provides: "User invite/deactivate/role management table"
      exports: ["UserManagement"]
    - path: "frontend/src/components/admin/SystemHealthSection.tsx"
      provides: "Webhook and token health dashboard"
      exports: ["SystemHealthSection"]
  key_links:
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/AdminPage.tsx"
      via: "Admin route with role guard"
      pattern: "path.*admin.*AdminPage"
    - from: "frontend/src/components/layout/AppSidebar.tsx"
      to: "frontend/src/stores/authStore.ts"
      via: "Role-based nav filtering"
      pattern: "user\\.role.*admin"
    - from: "frontend/src/api/admin.ts"
      to: "/api/admin/*"
      via: "apiFetch to admin endpoints"
      pattern: "apiFetch.*admin"
---

<objective>
Build the Admin Panel page with user management, org-wide rules, aggregate analytics, and system health monitoring, plus add admin-only navigation and route guarding.

Purpose: PAGE-07 requires an admin panel that is only accessible to admin users. This completes the final UI page and adds role-based navigation filtering to the sidebar.

Output: AdminPage with 4 tabbed sections, admin route guard in App.tsx, admin nav item with role-based visibility in sidebar.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-notifications-admin/07-RESEARCH.md
@.planning/phases/07-polish-notifications-admin/07-01-SUMMARY.md
@.planning/phases/07-polish-notifications-admin/07-02-SUMMARY.md
@frontend/src/App.tsx
@frontend/src/lib/constants.ts
@frontend/src/components/layout/AppSidebar.tsx
@frontend/src/stores/authStore.ts
@frontend/src/api/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin API client, hooks, and page with all four tabbed sections</name>
  <files>
    frontend/src/api/admin.ts
    frontend/src/hooks/useAdmin.ts
    frontend/src/components/admin/UserManagement.tsx
    frontend/src/components/admin/OrgRulesSection.tsx
    frontend/src/components/admin/AnalyticsSection.tsx
    frontend/src/components/admin/SystemHealthSection.tsx
    frontend/src/pages/AdminPage.tsx
  </files>
  <action>
    **Create `frontend/src/api/admin.ts`:**
    - Follow existing API client pattern (apiFetch from @/api/client).
    - Types:
      ```
      AdminUser { id: string; email: string; displayName?: string; role: 'admin' | 'user'; isActive: boolean; lastLoginAt?: string; createdAt: string }
      AdminAnalytics { totalUsers: number; activeUsers: number; totalEvents: number; totalRules: number; totalPatterns: number }
      SubscriptionHealth { subscriptionId: string; status: string; expiresAt: string; lastNotificationAt?: string; errorCount: number; mailboxId: { _id: string; email: string; displayName?: string }; userId: { _id: string; email: string; displayName?: string } }
      TokenHealth { mailboxId: string; email: string; user: { _id: string; email: string; displayName?: string }; isConnected: boolean; tokenExpiresAt?: string; tokenHealthy: boolean; lastSyncAt?: string }
      SystemHealth { subscriptions: SubscriptionHealth[]; tokenHealth: TokenHealth[] }
      OrgRule { _id: string; name: string; conditions: { senderEmail?: string; senderDomain?: string; subjectContains?: string }; actions: { actionType: string; toFolder?: string; order?: number }[]; isEnabled: boolean; priority: number; scope: 'org'; createdAt: string }
      ```
    - Functions:
      - `fetchAdminUsers(): Promise<AdminUser[]>` -- GET /api/admin/users
      - `inviteUser(email: string, role?: string): Promise<AdminUser>` -- POST /api/admin/invite
      - `changeUserRole(userId: string, role: string): Promise<AdminUser>` -- PATCH /api/admin/users/{userId}/role
      - `deactivateUser(userId: string): Promise<AdminUser>` -- PATCH /api/admin/users/{userId}/deactivate
      - `fetchAnalytics(): Promise<AdminAnalytics>` -- GET /api/admin/analytics
      - `fetchSystemHealth(): Promise<SystemHealth>` -- GET /api/admin/health
      - `fetchOrgRules(): Promise<OrgRule[]>` -- GET /api/admin/org-rules
      - `createOrgRule(data: { name: string; conditions: object; actions: object[]; priority?: number }): Promise<OrgRule>` -- POST /api/admin/org-rules
      - `deleteOrgRule(id: string): Promise<{ success: boolean }>` -- DELETE /api/admin/org-rules/{id}

    **Create `frontend/src/hooks/useAdmin.ts`:**
    - `useAdminUsers()` -- useQuery key ['admin-users'], calls fetchAdminUsers.
    - `useInviteUser()` -- useMutation calling inviteUser, on success invalidate ['admin-users'], show toast "User invited". On error, if status 409 show toast "User already exists".
    - `useChangeRole()` -- useMutation calling changeUserRole, on success invalidate ['admin-users'], show toast "Role updated".
    - `useDeactivateUser()` -- useMutation calling deactivateUser, on success invalidate ['admin-users'], show toast "User deactivated".
    - `useAdminAnalytics()` -- useQuery key ['admin-analytics'], calls fetchAnalytics.
    - `useSystemHealth()` -- useQuery key ['admin-health'], calls fetchSystemHealth, refetchInterval 60_000 (auto-refresh every minute).
    - `useOrgRules()` -- useQuery key ['admin-org-rules'], calls fetchOrgRules.
    - `useCreateOrgRule()` -- useMutation calling createOrgRule, on success invalidate ['admin-org-rules'], show toast "Org rule created".
    - `useDeleteOrgRule()` -- useMutation calling deleteOrgRule, on success invalidate ['admin-org-rules'], show toast "Org rule deleted".

    **Create `frontend/src/components/admin/AnalyticsSection.tsx`:**
    - Uses `useAdminAnalytics()` hook.
    - Displays 5 stat cards in a responsive grid (grid-cols-2 md:grid-cols-3 lg:grid-cols-5):
      - Total Users (Users icon), Active Users (UserCheck icon), Total Events (Mail icon), Active Rules (Shield icon), Pending Patterns (Brain icon).
    - Each card: shadcn Card with title, large number, and icon. Follow the existing DashboardPage stats card pattern.
    - Loading state: Skeleton components.

    **Create `frontend/src/components/admin/UserManagement.tsx`:**
    - Uses `useAdminUsers()`, `useInviteUser()`, `useChangeRole()`, `useDeactivateUser()` hooks.
    - **Invite form** at top: Input (email) + Select (role: user/admin, default user) + Button "Invite". Validate email before submitting.
    - **User table** below: shadcn Table component.
      - Columns: Email, Display Name, Role, Status (Active/Inactive badge), Last Login (formatDistanceToNow), Actions.
      - Actions column: DropdownMenu with "Change to Admin"/"Change to User" (toggle based on current role) and "Deactivate" option.
      - Deactivate shows AlertDialog confirmation ("Deactivate {user.email}?").
      - Do NOT show actions for the current user (use authStore user.id to check -- per admin self-protection pattern from Phase 02).
    - Handle 409 error from invite (ConflictError): show toast "User already exists" (per decision 02-02).

    **Create `frontend/src/components/admin/OrgRulesSection.tsx`:**
    - Uses `useOrgRules()`, `useCreateOrgRule()`, `useDeleteOrgRule()` hooks.
    - **Create form**: Dialog (shadcn) triggered by "Create Org Rule" button.
      - Fields: name (Input), senderEmail or senderDomain (Input), action type (Select: move/delete/markRead/archive), toFolder (Input, shown only for move action), priority (Input number).
      - On submit, create rule and close dialog.
    - **Rules list**: Card list showing each org rule with name, conditions summary, actions summary, and delete button (with AlertDialog confirmation).
    - Empty state: "No org-wide rules. Create one to apply rules across all users."

    **Create `frontend/src/components/admin/SystemHealthSection.tsx`:**
    - Uses `useSystemHealth()` hook.
    - **Webhook Subscriptions table**: shadcn Table.
      - Columns: Mailbox Email, User, Status (badge: green active, red expired/failed), Expires At, Last Notification, Error Count.
      - Color-code status: active = green badge, expired = yellow, failed = red.
    - **Token Health table**: shadcn Table.
      - Columns: Mailbox Email, User, Connected (green/red badge), Token Healthy (green/red badge), Token Expires, Last Sync.
      - Use Progress component to visualize token time remaining (full = just refreshed, low = near expiry).
    - Section headers: "Webhook Subscriptions" and "Token Health" with description text.
    - Auto-refreshes every 60 seconds via the hook's refetchInterval.

    **Create `frontend/src/pages/AdminPage.tsx`:**
    - Export named `AdminPage` function component.
    - Page header: "Admin Panel" title, "Manage users, org-wide rules, and system health" description.
    - Uses Tabs component (shadcn) with 4 tabs:
      - "Users" -> UserManagement
      - "Org Rules" -> OrgRulesSection
      - "Analytics" -> AnalyticsSection
      - "System Health" -> SystemHealthSection
    - Default tab: "Users".
    - No need to check role here -- the route guard in App.tsx handles it.
  </action>
  <verify>
    - `npx tsc --noEmit --project frontend/tsconfig.json` passes.
    - `ls frontend/src/components/admin/` shows UserManagement.tsx, OrgRulesSection.tsx, AnalyticsSection.tsx, SystemHealthSection.tsx.
    - `ls frontend/src/pages/AdminPage.tsx` confirms page exists.
  </verify>
  <done>
    AdminPage has 4 tabbed sections. Users tab supports invite, role change, and deactivate with self-protection. Org Rules tab supports create/delete of org-wide rules. Analytics tab shows aggregate stats. System Health tab shows webhook subscription and token health tables with auto-refresh.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin route, admin guard, and role-based sidebar navigation</name>
  <files>
    frontend/src/App.tsx
    frontend/src/lib/constants.ts
    frontend/src/components/layout/AppSidebar.tsx
  </files>
  <action>
    **Update `frontend/src/lib/constants.ts`:**
    - Add `admin: '/admin'` to ROUTE_PATHS.
    - Add `adminOnly?: boolean` optional field to the NavItem interface.
    - Add Admin Panel nav item to NAV_ITEMS array (after Settings):
      ```typescript
      { label: 'Admin Panel', path: ROUTE_PATHS.admin, icon: ShieldCheck, adminOnly: true }
      ```
    - Import `ShieldCheck` from lucide-react (represents admin with authority).

    **Update `frontend/src/components/layout/AppSidebar.tsx`:**
    - Import `useAuthStore` from `@/stores/authStore`.
    - Get the current user: `const user = useAuthStore((s) => s.user);`.
    - Filter NAV_ITEMS based on user role before mapping:
      ```typescript
      const visibleItems = NAV_ITEMS.filter(
        (item) => !item.adminOnly || user?.role === 'admin'
      );
      ```
    - Replace `NAV_ITEMS.map(...)` with `visibleItems.map(...)`.
    - This ensures non-admin users never see the Admin Panel link (per Research Pitfall 5).

    **Update `frontend/src/App.tsx`:**
    - Import `AdminPage` from `@/pages/AdminPage`.
    - Import `Navigate` (already imported from react-router).
    - Import `useAuthStore` (already imported).
    - Create an `AdminGuard` component inside App.tsx (above the router definition):
      ```typescript
      function AdminGuard() {
        const user = useAuthStore((s) => s.user);
        if (user?.role !== 'admin') return <Navigate to="/" replace />;
        return <AdminPage />;
      }
      ```
    - Add the admin route to the ProtectedLayout children, after the settings route:
      ```typescript
      {
        path: '/admin',
        element: <AdminGuard />,
      },
      ```
    - This provides frontend route protection (backend `requireAdmin` middleware is the real security boundary -- per Research anti-pattern warning).
  </action>
  <verify>
    - `npx tsc --noEmit --project frontend/tsconfig.json` passes.
    - Grep `adminOnly` in `frontend/src/lib/constants.ts` confirms field exists.
    - Grep `AdminGuard` in `frontend/src/App.tsx` confirms route guard exists.
    - Grep `visibleItems` or `adminOnly` in `frontend/src/components/layout/AppSidebar.tsx` confirms role filtering.
    - Grep `ShieldCheck` in `frontend/src/lib/constants.ts` confirms admin icon import.
  </verify>
  <done>
    Admin Panel route is guarded -- non-admin users get redirected to dashboard. Sidebar filters out Admin Panel nav item for non-admin users. Backend requireAdmin middleware provides the real security boundary.
  </done>
</task>

</tasks>

<verification>
- Frontend TypeScript compiles: `npx tsc --noEmit --project frontend/tsconfig.json`
- AdminPage renders with 4 tabs (Users, Org Rules, Analytics, System Health)
- /admin route is guarded by AdminGuard component
- Non-admin users cannot see Admin Panel in sidebar
- Admin can invite users, change roles, deactivate users
- Admin can create and delete org-wide rules
- Analytics shows aggregate counts
- System health shows webhook and token status tables
</verification>

<success_criteria>
- Admin Panel link appears in sidebar only for admin users
- /admin route redirects non-admins to dashboard
- Users tab: invite form creates user, role dropdown changes role, deactivate with confirmation
- Org Rules tab: create dialog produces org rule, delete with confirmation
- Analytics tab: 5 stat cards showing aggregate data
- System Health tab: two tables showing webhook subscription status and token health
- Self-protection: admin cannot demote or deactivate themselves
- 409 conflict error handled gracefully for duplicate invites
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-notifications-admin/07-03-SUMMARY.md`
</output>
