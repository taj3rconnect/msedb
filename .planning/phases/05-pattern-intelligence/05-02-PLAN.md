---
phase: 05-pattern-intelligence
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - backend/src/jobs/processors/patternAnalysis.ts
  - backend/src/jobs/queues.ts
  - backend/src/routes/patterns.ts
  - backend/src/routes/dashboard.ts
  - backend/src/server.ts
autonomous: true
requirements:
  - PATN-04

must_haves:
  truths:
    - "Pattern analysis BullMQ processor calls analyzeMailboxPatterns for all connected mailboxes at 2 AM daily"
    - "GET /api/patterns returns paginated patterns filtered by mailboxId and/or status"
    - "POST /api/patterns/:id/approve sets pattern status to approved, records approvedAt, creates audit log"
    - "POST /api/patterns/:id/reject sets pattern status to rejected, sets rejectedAt and 30-day cooldown, creates audit log"
    - "POST /api/patterns/:id/customize allows user to modify pattern action before approving"
    - "Dashboard /api/dashboard/stats returns real patternsPending count from Pattern collection"
    - "Pattern analysis job can be triggered on-demand via POST /api/patterns/analyze"
  artifacts:
    - path: "backend/src/jobs/processors/patternAnalysis.ts"
      provides: "BullMQ processor for pattern-analysis queue"
      exports: ["processPatternAnalysis"]
    - path: "backend/src/routes/patterns.ts"
      provides: "REST API for pattern CRUD + approve/reject/customize"
      exports: ["patternsRouter"]
    - path: "backend/src/jobs/queues.ts"
      provides: "Updated processorMap with real pattern-analysis processor"
      contains: "processPatternAnalysis"
    - path: "backend/src/routes/dashboard.ts"
      provides: "Updated stats endpoint with real patternsPending count"
      contains: "Pattern.countDocuments"
    - path: "backend/src/server.ts"
      provides: "patterns route mounted at /api/patterns"
      contains: "patternsRouter"
  key_links:
    - from: "backend/src/jobs/processors/patternAnalysis.ts"
      to: "backend/src/services/patternEngine.ts"
      via: "import analyzeMailboxPatterns"
      pattern: "analyzeMailboxPatterns"
    - from: "backend/src/routes/patterns.ts"
      to: "backend/src/models/Pattern.ts"
      via: "Pattern.find, Pattern.findOne, pattern.save"
      pattern: "Pattern\\.(find|findOne)"
    - from: "backend/src/routes/patterns.ts"
      to: "backend/src/models/AuditLog.ts"
      via: "AuditLog.create for approve/reject actions"
      pattern: "AuditLog\\.create"
    - from: "backend/src/server.ts"
      to: "backend/src/routes/patterns.ts"
      via: "app.use('/api/patterns', patternsRouter)"
      pattern: "patternsRouter"
---

<objective>
Wire the pattern detection engine into BullMQ as a production processor and create REST API endpoints for listing, approving, rejecting, and customizing pattern suggestions.

Purpose: The detection engine (05-01) produces patterns; this plan makes them accessible -- the BullMQ processor runs detection daily, and the API lets users manage suggestions.

Output: Production BullMQ pattern-analysis processor, pattern REST API, updated dashboard stats, route mount in server.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pattern-intelligence/05-RESEARCH.md
@.planning/phases/05-pattern-intelligence/05-01-SUMMARY.md

@backend/src/jobs/queues.ts
@backend/src/jobs/processors/deltaSync.ts
@backend/src/routes/dashboard.ts
@backend/src/routes/events.ts
@backend/src/server.ts
@backend/src/models/Pattern.ts
@backend/src/models/AuditLog.ts
@backend/src/middleware/errorHandler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: BullMQ pattern-analysis processor and patterns REST API</name>
  <files>
    backend/src/jobs/processors/patternAnalysis.ts
    backend/src/jobs/queues.ts
    backend/src/routes/patterns.ts
  </files>
  <action>
    **1. Create `backend/src/jobs/processors/patternAnalysis.ts`:**
    - Follow the exact same pattern as deltaSync.ts processor
    - Export `processPatternAnalysis(job: Job): Promise<void>`
    - Handle job name `'run-pattern-analysis'` (from the existing 2 AM scheduler)
    - Query `Mailbox.find({ isConnected: true })`
    - For each mailbox, call `analyzeMailboxPatterns(mailbox.userId.toString(), mailbox._id.toString())`
    - Wrap each mailbox in try/catch for error isolation (same as deltaSync pattern)
    - Log job start, per-mailbox progress, and completion summary (analyzed count, failed count)
    - Also handle job name `'on-demand-analysis'` with `job.data.userId` and `job.data.mailboxId` for single-mailbox trigger

    **2. Update `backend/src/jobs/queues.ts`:**
    - Import `processPatternAnalysis` from `./processors/patternAnalysis.js`
    - Replace `createProcessor('pattern-analysis')` with `processPatternAnalysis` in the processorMap

    **3. Create `backend/src/routes/patterns.ts`:**
    - Create Express Router, apply `requireAuth` middleware
    - Export as `patternsRouter`

    **GET `/` (list patterns):**
    - Scoped to `req.user!.userId`
    - Query params: `mailboxId` (optional), `status` (optional, comma-separated for multiple), `page` (default 1), `limit` (default 20, max 100)
    - Sort by `confidence` descending, then `createdAt` descending
    - Return `{ patterns, pagination: { page, limit, total, totalPages } }`

    **POST `/:id/approve`:**
    - Find pattern by `_id` and `userId` (security: user can only approve own patterns)
    - Validate status is 'detected' or 'suggested' (not already approved/rejected)
    - Set `status = 'approved'`, `approvedAt = new Date()`
    - Save pattern
    - Create AuditLog: `{ userId, mailboxId: pattern.mailboxId, action: 'pattern_approved', targetType: 'pattern', targetId: pattern._id.toString(), details: { patternType: pattern.patternType, confidence: pattern.confidence, condition: pattern.condition, suggestedAction: pattern.suggestedAction } }`
    - Return updated pattern

    **POST `/:id/reject`:**
    - Find pattern by `_id` and `userId`
    - Validate status is 'detected' or 'suggested'
    - Set `status = 'rejected'`, `rejectedAt = new Date()`, `rejectionCooldownUntil = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)` (30 days)
    - Save pattern
    - Create AuditLog with `action: 'pattern_rejected'`
    - Return updated pattern

    **POST `/:id/customize`:**
    - Find pattern by `_id` and `userId`
    - Validate status is 'detected' or 'suggested'
    - Accept body: `{ suggestedAction: { actionType, toFolder?, category? } }`
    - Validate actionType is one of the allowed enum values
    - Update `pattern.suggestedAction` with the customized action
    - Set `status = 'approved'`, `approvedAt = new Date()`
    - Save pattern
    - Create AuditLog with `action: 'pattern_approved'`, details include `customized: true` and original action
    - Return updated pattern

    **POST `/analyze`:**
    - Trigger on-demand pattern analysis for the current user
    - Accept optional body: `{ mailboxId }` -- if provided, analyze just that mailbox
    - Enqueue a job on the pattern-analysis queue with name `'on-demand-analysis'` and data `{ userId, mailboxId }`
    - Return `{ message: 'Pattern analysis queued', jobId }`
    - Import the `queues` object from `../jobs/queues.js` to access the pattern-analysis queue

    Use error classes from errorHandler.ts: NotFoundError (pattern not found), ConflictError (already approved), ValidationError (invalid actionType).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - queues.ts no longer has placeholder for pattern-analysis
    - All 5 endpoints are defined (GET /, POST /:id/approve, POST /:id/reject, POST /:id/customize, POST /analyze)
  </verify>
  <done>
    - BullMQ processor calls analyzeMailboxPatterns for all connected mailboxes (scheduled) or a specific mailbox (on-demand)
    - Pattern API provides list, approve, reject, customize, and on-demand analyze endpoints
    - All endpoints are scoped to the authenticated user
    - Approve/reject/customize create AuditLog entries
    - Rejected patterns get 30-day cooldown
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount patterns route and update dashboard stats</name>
  <files>
    backend/src/server.ts
    backend/src/routes/dashboard.ts
  </files>
  <action>
    **1. Update `backend/src/server.ts`:**
    - Import `{ patternsRouter }` from `./routes/patterns.js`
    - Mount: `app.use('/api/patterns', patternsRouter)` -- place after the events router mount, before the global error handler
    - Follow the same import/mount pattern as other routers (dashboardRouter, eventsRouter, etc.)

    **2. Update `backend/src/routes/dashboard.ts`:**
    - Import `Pattern` model from `../models/Pattern.js`
    - In the GET `/stats` endpoint, replace the hardcoded `patternsPending: 0` with a real count
    - Add: `const patternsPending = await Pattern.countDocuments({ userId, status: { $in: ['detected', 'suggested'] } })`
    - If `mailboxId` filter is provided, add it to the patternsPending query too
    - This makes the dashboard stats card show the real number of pending pattern suggestions
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - server.ts has the patterns route mount
    - dashboard.ts imports Pattern and uses countDocuments instead of hardcoded 0
  </verify>
  <done>
    - Patterns API is accessible at /api/patterns/*
    - Dashboard stats endpoint returns real patternsPending count from the Pattern collection
    - All routes compile and follow existing codebase conventions
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit` (in backend directory)
- queues.ts processorMap uses real processPatternAnalysis (not placeholder)
- GET /api/patterns endpoint exists and returns paginated patterns
- POST /api/patterns/:id/approve, reject, customize endpoints exist
- POST /api/patterns/analyze triggers on-demand analysis
- Dashboard stats patternsPending reflects real Pattern count
</verification>

<success_criteria>
- Pattern analysis BullMQ processor is production-ready and replaces the placeholder
- REST API has 5 endpoints for pattern management with proper auth, validation, and audit logging
- Dashboard stats show real pending pattern count
- All code follows existing codebase conventions (route-level auth, error classes, Express 5 async)
</success_criteria>

<output>
After completion, create `.planning/phases/05-pattern-intelligence/05-02-SUMMARY.md`
</output>
