---
phase: 05-pattern-intelligence
plan: 03
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - frontend/src/api/patterns.ts
  - frontend/src/hooks/usePatterns.ts
  - frontend/src/components/patterns/PatternCard.tsx
  - frontend/src/components/patterns/PatternFilters.tsx
  - frontend/src/components/patterns/PatternCustomizeDialog.tsx
  - frontend/src/pages/PatternsPage.tsx
  - frontend/src/App.tsx
  - frontend/src/components/dashboard/PendingSuggestionsSection.tsx
autonomous: true
requirements:
  - PATN-04
  - PAGE-02

must_haves:
  truths:
    - "Patterns page shows card-based layout with each pattern displaying confidence %, sample size, exception count, and sample evidence"
    - "User can approve a pattern suggestion from the Patterns page"
    - "User can reject a pattern suggestion, triggering 30-day cooldown"
    - "User can customize a pattern's action before approving (change actionType or target folder)"
    - "Patterns page has filters for status and pattern type"
    - "Confidence is visualized as a colored progress bar (green >= 95%, yellow >= 85%, orange below)"
    - "Dashboard PendingSuggestionsSection shows top pending patterns with a link to the Patterns page"
  artifacts:
    - path: "frontend/src/api/patterns.ts"
      provides: "API functions for patterns endpoints"
      exports: ["fetchPatterns", "approvePattern", "rejectPattern", "customizePattern", "triggerAnalysis"]
    - path: "frontend/src/hooks/usePatterns.ts"
      provides: "TanStack Query hooks for patterns data"
      exports: ["usePatterns", "useApprovePattern", "useRejectPattern", "useCustomizePattern", "useTriggerAnalysis"]
    - path: "frontend/src/components/patterns/PatternCard.tsx"
      provides: "Individual pattern suggestion card component"
      exports: ["PatternCard"]
    - path: "frontend/src/components/patterns/PatternFilters.tsx"
      provides: "Status and pattern type filter controls"
      exports: ["PatternFilters"]
    - path: "frontend/src/components/patterns/PatternCustomizeDialog.tsx"
      provides: "Dialog for customizing pattern action before approval"
      exports: ["PatternCustomizeDialog"]
    - path: "frontend/src/pages/PatternsPage.tsx"
      provides: "Full patterns page replacing ComingSoonPage"
      exports: ["PatternsPage"]
    - path: "frontend/src/App.tsx"
      provides: "Updated route for /patterns pointing to PatternsPage"
      contains: "PatternsPage"
    - path: "frontend/src/components/dashboard/PendingSuggestionsSection.tsx"
      provides: "Updated section showing real pending patterns from API"
      contains: "usePatterns"
  key_links:
    - from: "frontend/src/hooks/usePatterns.ts"
      to: "frontend/src/api/patterns.ts"
      via: "import fetch/mutation functions"
      pattern: "import.*from.*api/patterns"
    - from: "frontend/src/pages/PatternsPage.tsx"
      to: "frontend/src/hooks/usePatterns.ts"
      via: "usePatterns hook for data, mutation hooks for actions"
      pattern: "usePatterns|useApprovePattern|useRejectPattern"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/PatternsPage.tsx"
      via: "Route element at /patterns"
      pattern: "<PatternsPage"
    - from: "frontend/src/components/dashboard/PendingSuggestionsSection.tsx"
      to: "frontend/src/hooks/usePatterns.ts"
      via: "usePatterns hook with status filter"
      pattern: "usePatterns"
---

<objective>
Build the Patterns page UI with card-based pattern suggestions showing confidence visualization, sample evidence, and approve/reject/customize actions. Update the dashboard's PendingSuggestionsSection to show real pattern data.

Purpose: This is the user-facing surface of the pattern intelligence system. Users review, approve, reject, or customize detected patterns here. The UI must communicate confidence clearly and make decision-making effortless.

Output: Full Patterns page, pattern management components, API integration hooks, and updated dashboard section.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pattern-intelligence/05-RESEARCH.md
@.planning/phases/05-pattern-intelligence/05-01-SUMMARY.md

@frontend/src/api/client.ts
@frontend/src/api/dashboard.ts
@frontend/src/hooks/useDashboard.ts
@frontend/src/pages/DashboardPage.tsx
@frontend/src/pages/EmailActivityPage.tsx
@frontend/src/pages/ComingSoonPage.tsx
@frontend/src/App.tsx
@frontend/src/components/dashboard/PendingSuggestionsSection.tsx
@frontend/src/components/dashboard/StatsCards.tsx
@backend/src/models/Pattern.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pattern API layer, hooks, and card components</name>
  <files>
    frontend/src/api/patterns.ts
    frontend/src/hooks/usePatterns.ts
    frontend/src/components/patterns/PatternCard.tsx
    frontend/src/components/patterns/PatternFilters.tsx
    frontend/src/components/patterns/PatternCustomizeDialog.tsx
  </files>
  <action>
    **1. Create `frontend/src/api/patterns.ts`:**
    Follow the exact pattern of `frontend/src/api/dashboard.ts`.

    Types (mirror backend Pattern model):
    ```typescript
    export interface PatternCondition {
      senderEmail?: string;
      senderDomain?: string;
      fromFolder?: string;
      subjectPattern?: string;
    }
    export interface PatternSuggestedAction {
      actionType: 'delete' | 'move' | 'archive' | 'markRead' | 'flag' | 'categorize';
      toFolder?: string;
      category?: string;
    }
    export interface PatternEvidence {
      messageId: string;
      timestamp: string;
      action: string;
    }
    export interface Pattern {
      _id: string;
      userId: string;
      mailboxId: string;
      patternType: 'sender' | 'folder-routing';
      status: 'detected' | 'suggested' | 'approved' | 'rejected' | 'expired';
      confidence: number;
      sampleSize: number;
      exceptionCount: number;
      condition: PatternCondition;
      suggestedAction: PatternSuggestedAction;
      evidence: PatternEvidence[];
      rejectedAt?: string;
      rejectionCooldownUntil?: string;
      approvedAt?: string;
      lastAnalyzedAt?: string;
      createdAt: string;
      updatedAt: string;
    }
    export interface PatternsResponse {
      patterns: Pattern[];
      pagination: { page: number; limit: number; total: number; totalPages: number };
    }
    ```

    Functions:
    - `fetchPatterns(params?: { mailboxId?: string; status?: string; page?: number; limit?: number })` -> GET /patterns with query params
    - `approvePattern(patternId: string)` -> POST /patterns/:id/approve
    - `rejectPattern(patternId: string)` -> POST /patterns/:id/reject
    - `customizePattern(patternId: string, action: PatternSuggestedAction)` -> POST /patterns/:id/customize with body
    - `triggerAnalysis(mailboxId?: string)` -> POST /patterns/analyze with optional body

    **2. Create `frontend/src/hooks/usePatterns.ts`:**
    Follow the pattern of `frontend/src/hooks/useDashboard.ts`.

    - `usePatterns(mailboxId?: string | null, status?: string)` -> useQuery with key `['patterns', mailboxId, status]`
    - `useApprovePattern()` -> useMutation, on success invalidate `['patterns']` and `['dashboard', 'stats']`
    - `useRejectPattern()` -> useMutation, on success invalidate `['patterns']` and `['dashboard', 'stats']`
    - `useCustomizePattern()` -> useMutation accepting `{ patternId: string, action: PatternSuggestedAction }`, on success invalidate `['patterns']` and `['dashboard', 'stats']`
    - `useTriggerAnalysis()` -> useMutation, on success invalidate `['patterns']`

    **3. Create `frontend/src/components/patterns/PatternCard.tsx`:**
    Uses shadcn Card, Badge, Button (already installed). Import lucide-react icons: Check, X, Settings2, Mail, FolderOutput, Trash2.

    Props: `pattern: Pattern`, `onApprove: (id: string) => void`, `onReject: (id: string) => void`, `onCustomize: (id: string) => void`, `isApproving?: boolean`, `isRejecting?: boolean`

    Layout:
    - Card with CardHeader containing:
      - Pattern type badge: "Sender Pattern" (purple) or "Folder Routing" (blue) using Badge variant
      - Status badge: color-coded (detected=gray, suggested=yellow, approved=green, rejected=red)
    - CardContent containing:
      - **Description line:** Human-readable pattern description
        - Sender: "You {action} {actionCount} of {sampleSize} emails from {senderEmail}" (e.g., "You deleted 97 of 100 emails from newsletter@example.com")
        - Folder routing: "You move emails from {senderEmail} to {toFolder}" with count
      - **Confidence bar:** A div with background color based on confidence value:
        - >= 95%: green-500
        - >= 85%: yellow-500
        - < 85%: orange-500
        - Width set via `style={{ width: \`${confidence}%\` }}`
        - Label showing "{confidence}% confidence"
      - **Stats row:** Sample size, exception count, observation period (formatted from firstSeen evidence)
        - "{sampleSize} emails observed" | "{exceptionCount} exceptions" | "Since {date}"
      - **Evidence section:** Collapsible (use a simple toggle state), showing the last 5 evidence items with timestamp and action
    - CardFooter with action buttons (only for 'detected' or 'suggested' status):
      - Approve button (green): Check icon + "Approve" -- disabled while isApproving
      - Reject button (red outline): X icon + "Reject" -- disabled while isRejecting
      - Customize button (outline): Settings2 icon + "Customize"

    **4. Create `frontend/src/components/patterns/PatternFilters.tsx`:**
    Props: `status: string`, `patternType: string`, `onStatusChange: (status: string) => void`, `onPatternTypeChange: (type: string) => void`

    Uses shadcn Select for status filter (options: All, Detected, Suggested, Approved, Rejected) and pattern type filter (All, Sender, Folder Routing). Renders as a flex row with two select dropdowns.

    **5. Create `frontend/src/components/patterns/PatternCustomizeDialog.tsx`:**
    Uses shadcn sheet component (already installed as Sheet) as a side panel dialog.
    Props: `pattern: Pattern | null`, `open: boolean`, `onOpenChange: (open: boolean) => void`, `onConfirm: (patternId: string, action: PatternSuggestedAction) => void`, `isSubmitting?: boolean`

    Content:
    - Show current pattern details (sender, confidence)
    - Select for actionType (delete, move, archive, markRead, flag, categorize)
    - Conditional text input for toFolder (shown when actionType is 'move')
    - Conditional text input for category (shown when actionType is 'categorize')
    - Confirm button: "Approve with Changes" (disabled while isSubmitting)
    - Cancel button
    - Use local state for form fields, initialize from pattern.suggestedAction when pattern changes
  </action>
  <verify>
    - `npx tsc --noEmit` passes (from frontend directory)
    - All 5 files exist and export correctly
    - PatternCard renders confidence bar, stats, evidence, and action buttons
    - PatternCustomizeDialog provides action customization form
  </verify>
  <done>
    - API layer matches backend endpoints with typed responses
    - TanStack Query hooks handle fetching and mutations with cache invalidation
    - PatternCard shows confidence bar, stats, evidence, and approve/reject/customize buttons
    - PatternFilters provides status and type filtering
    - PatternCustomizeDialog allows customizing action before approval
  </done>
</task>

<task type="auto">
  <name>Task 2: Patterns page, route update, and dashboard integration</name>
  <files>
    frontend/src/pages/PatternsPage.tsx
    frontend/src/App.tsx
    frontend/src/components/dashboard/PendingSuggestionsSection.tsx
  </files>
  <action>
    **1. Create `frontend/src/pages/PatternsPage.tsx`:**
    Follow the page component pattern of EmailActivityPage.tsx (named export function, uses hooks).

    Layout:
    - Page header: "Patterns" title + "Analyze Now" button (triggers useTriggerAnalysis mutation)
    - PatternFilters component for status and patternType filtering
    - Use `usePatterns` hook with selected mailboxId (from uiStore) and filter values
    - Loading state: grid of Skeleton cards (3-4 items)
    - Error state: EmptyState with AlertCircle icon
    - Empty state: EmptyState with Brain icon, "No patterns found" with contextual message based on filters
    - Data state: CSS grid of PatternCard components (1 col mobile, 2 cols md, 3 cols lg)
    - Pagination: simple "Page X of Y" with previous/next buttons at bottom (use shadcn Button)
    - Wire up approve/reject/customize:
      - `useApprovePattern` for approve action
      - `useRejectPattern` for reject action
      - `useCustomizePattern` for customize confirm
      - Track `customizeTarget` in local state (Pattern | null) to control dialog open/close
    - Use `useUiStore` for `selectedMailboxId` (consistent with other pages)

    **2. Update `frontend/src/App.tsx`:**
    - Import `PatternsPage` from `@/pages/PatternsPage`
    - Replace the `/patterns` route element from `<ComingSoonPage title="Patterns" />` to `<PatternsPage />`
    - Keep all other routes unchanged

    **3. Update `frontend/src/components/dashboard/PendingSuggestionsSection.tsx`:**
    Replace the stub implementation with a real one that fetches pending patterns:
    - Import and use `usePatterns` hook with status filter 'suggested' (only show suggested patterns, not just detected)
    - Import PatternCard or create a condensed summary view
    - Show top 3 pending patterns as condensed cards (show description line + confidence bar + approve/reject buttons, no evidence section)
    - Add a "View All Patterns" link (react-router Link to /patterns) at the bottom when there are more suggestions
    - Keep the existing empty state (Brain icon, "No Patterns Detected Yet") when no suggestions exist
    - Wire approve/reject mutations using useApprovePattern and useRejectPattern
    - Remove the old `suggestions?: unknown[]` prop -- the component now fetches its own data
    - Update DashboardPage.tsx if needed to remove the prop (currently PendingSuggestionsSection is called without props, so this should be clean)
    - Import `useUiStore` for selectedMailboxId to scope the query
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `/patterns` route renders PatternsPage (not ComingSoonPage)
    - PatternsPage shows grid of PatternCards with filters and pagination
    - PendingSuggestionsSection fetches real pattern data
    - Build succeeds: `npm run build`
  </verify>
  <done>
    - Patterns page shows card-based layout with confidence visualization, evidence, and approve/reject/customize actions
    - Patterns page has status and type filters with pagination
    - Dashboard PendingSuggestionsSection shows real pending suggestions (top 3) with link to Patterns page
    - /patterns route points to PatternsPage, not ComingSoonPage
    - All TypeScript compiles, build succeeds
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in frontend directory
- `npm run build` succeeds in frontend directory
- /patterns route renders PatternsPage with card grid
- PatternCards show confidence bar, sample size, exception count, evidence
- Approve/reject/customize buttons are functional (wired to mutation hooks)
- Dashboard PendingSuggestionsSection shows real pending patterns
- Filters work for status and pattern type
</verification>

<success_criteria>
- Pattern suggestion cards display confidence %, sample size, exception count, and up to 5 evidence items
- Confidence bar is color-coded (green >= 95%, yellow >= 85%, orange below)
- User can approve, reject, or customize patterns from both the Patterns page and the dashboard
- Rejected patterns show the 30-day cooldown in the UI (status badge)
- Patterns page has working pagination and filters
- Dashboard integration shows real pending pattern count and top suggestions
</success_criteria>

<output>
After completion, create `.planning/phases/05-pattern-intelligence/05-03-SUMMARY.md`
</output>
