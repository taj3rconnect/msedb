---
phase: 05-pattern-intelligence
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/src/services/patternEngine.ts
  - backend/src/services/__tests__/patternEngine.test.ts
autonomous: true
requirements:
  - PATN-01
  - PATN-02
  - PATN-03

must_haves:
  truths:
    - "Sender-level patterns are detected when a user consistently performs the same action on emails from a specific sender (10+ events, 14+ days)"
    - "Folder routing patterns are detected when a user consistently moves emails from a sender to the same folder"
    - "Confidence scoring applies asymmetric thresholds: 98%+ for delete suggestions, 85%+ for move suggestions"
    - "Sample size bonus increases confidence for large sample sizes (logarithmic scale)"
    - "Recency penalty decreases confidence when recent behavior diverges from overall pattern"
    - "Patterns in 30-day rejection cooldown are not re-suggested"
    - "Automated events (metadata.automatedByRule) are excluded from analysis to prevent feedback loops"
  artifacts:
    - path: "backend/src/services/patternEngine.ts"
      provides: "Pattern detection engine with sender-level detection, folder routing detection, confidence scoring, and pattern persistence"
      exports: ["analyzeMailboxPatterns", "detectSenderPatterns", "detectFolderRoutingPatterns", "calculateConfidence", "shouldSuggestPattern", "SUGGESTION_THRESHOLDS"]
    - path: "backend/src/services/__tests__/patternEngine.test.ts"
      provides: "Unit tests for confidence scoring, threshold gating, and pattern suggestion logic"
      min_lines: 100
  key_links:
    - from: "backend/src/services/patternEngine.ts"
      to: "backend/src/models/EmailEvent.ts"
      via: "MongoDB aggregation pipeline"
      pattern: "EmailEvent\\.aggregate"
    - from: "backend/src/services/patternEngine.ts"
      to: "backend/src/models/Pattern.ts"
      via: "Pattern upsert (findOne + save or create)"
      pattern: "Pattern\\.(findOne|create)"
---

<objective>
Build the pattern detection engine that analyzes EmailEvent data to identify sender-level and folder routing patterns, scores confidence with asymmetric risk thresholds, and persists qualifying patterns to the Pattern collection.

Purpose: This is the core intelligence module that transforms raw email event data into actionable pattern suggestions. It must be reliable, well-tested, and produce zero false positives for destructive actions (delete).

Output: `backend/src/services/patternEngine.ts` with full test coverage for confidence scoring and threshold logic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pattern-intelligence/05-RESEARCH.md

@backend/src/models/EmailEvent.ts
@backend/src/models/Pattern.ts
@backend/src/models/Mailbox.ts
@backend/src/models/AuditLog.ts
@backend/src/services/deltaService.ts
</context>

<feature>
  <name>Pattern Detection Engine and Confidence Scorer</name>
  <files>backend/src/services/patternEngine.ts, backend/src/services/__tests__/patternEngine.test.ts</files>
  <behavior>
    **Confidence Scoring (pure function, TDD target):**
    - Input: `{ actionCount, totalEvents, firstSeen, lastSeen, recentActionCount, recentTotalEvents }`
    - Base rate = `(actionCount / totalEvents) * 100`
    - Sample size multiplier = `min(1.0 + log10(totalEvents / 10) * 0.05, 1.1)` -- at 10 events = 1.0x, 100+ events = ~1.1x max
    - Recency factor: if `recentTotalEvents >= 3`, compute recent rate vs overall rate divergence; penalty up to 15% (factor floor = 0.85)
    - Output: `min(100, round(baseRate * sampleMultiplier * recencyFactor))`
    - Test cases:
      - 97 of 100 events, no recency divergence -> confidence = 97 * ~1.05 = ~102 capped to 100
      - 10 of 10 events, no recency -> 100 * 1.0 = 100
      - 8 of 10 events, no recency -> 80 * 1.0 = 80
      - 97 of 100 events, but 0 of 5 recent -> recencyFactor = max(0.85, 1.0 - 0.97*0.5) = 0.85, confidence ~82
      - 3 of 100 events -> 3, well below any threshold

    **Threshold Gating (pure function, TDD target):**
    - `shouldSuggestPattern(confidence, actionType, firstSeen) -> boolean`
    - Thresholds: delete = 98, move = 85, archive = 85, markRead = 80
    - Must also check 14-day minimum observation period (daysSinceFirstSeen >= 14)
    - Test cases:
      - confidence=99, action=delete, 30 days -> true
      - confidence=97, action=delete, 30 days -> false (below 98)
      - confidence=86, action=move, 30 days -> true
      - confidence=86, action=move, 10 days -> false (< 14 days)

    **Sender-Level Detection (integration, uses MongoDB aggregation):**
    - `detectSenderPatterns(userId, mailboxId, observationWindowDays=90)` -> aggregation result
    - Groups EmailEvents by sender.email + sender.domain
    - Counts per-action-type (deleted, moved, read, arrived)
    - Filters to senders with 10+ total events
    - Excludes events where `metadata.automatedByRule` is set
    - Collects top 10 recent events as evidence via `$topN`

    **Folder Routing Detection:**
    - `detectFolderRoutingPatterns(userId, mailboxId, observationWindowDays=90)` -> aggregation result
    - Filters to eventType='moved', groups by sender.email + toFolder
    - Minimum 5 moves to the same folder from same sender
    - Collects evidence

    **Main Orchestrator:**
    - `analyzeMailboxPatterns(userId, mailboxId)` -- called by BullMQ processor and on-demand API
    - Runs both sender-level and folder routing detection
    - For each result, calculates confidence using 7-day recency window
    - Calls `shouldSuggestPattern` to gate
    - Uses upsert strategy: update existing patterns in 'detected'/'suggested' status, never overwrite 'approved'/'rejected'
    - Checks rejected pattern 30-day cooldown before creating new
    - Sets pattern status to 'suggested' if confidence exceeds threshold, 'detected' otherwise
    - For sender patterns, uses `arrived` count as denominator (total emails received from that sender)
    - Evidence capped at 10 items (Pattern model validator)
  </behavior>
  <implementation>
    RED phase: Write tests for calculateConfidence and shouldSuggestPattern covering all cases above. Tests must fail initially (functions don't exist).

    GREEN phase: Implement all functions in patternEngine.ts:
    1. Export constants: SUGGESTION_THRESHOLDS, MIN_OBSERVATION_DAYS (14), DEFAULT_OBSERVATION_WINDOW (90)
    2. Export pure functions: calculateConfidence, shouldSuggestPattern
    3. Export async functions: detectSenderPatterns, detectFolderRoutingPatterns, analyzeMailboxPatterns
    4. Use Types.ObjectId for userId/mailboxId in aggregation $match
    5. Aggregation must filter out automated events: `'metadata.automatedByRule': { $exists: false }`
    6. For sender patterns, compute action ratios against arrived count (not total events): "you deleted 97 of 100 emails" means 97 deleted out of 100 arrived
    7. For recency window: run a second aggregation for last 7 days to get recentActionCount and recentTotalEvents
    8. Upsert strategy: query Pattern with `{ userId, mailboxId, patternType, 'condition.senderEmail', 'suggestedAction.actionType', status: { $nin: ['approved', 'rejected'] } }` -- update if found, check cooldown if rejected exists, create if neither

    REFACTOR: Extract shared aggregation pipeline builders if duplication exists between sender and folder routing pipelines.
  </implementation>
</feature>

<verification>
- `npm test` passes all tests in patternEngine.test.ts
- Tests cover: confidence calculation edge cases, threshold gating, observation period check
- TypeScript compiles without errors: `npx tsc --noEmit`
- The module exports all required functions
</verification>

<success_criteria>
- calculateConfidence returns correct scores for all documented test cases
- shouldSuggestPattern enforces asymmetric thresholds (98% delete, 85% move) and 14-day minimum
- Sender-level detection aggregation groups by sender.email, counts action types, requires 10+ events
- Folder routing detection filters to 'moved' events, groups by sender + toFolder, requires 5+ moves
- analyzeMailboxPatterns persists Pattern documents with upsert strategy, respects rejection cooldowns
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-pattern-intelligence/05-01-SUMMARY.md`
</output>
