---
phase: 04-frontend-shell-observation-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/tsconfig.json
  - frontend/tsconfig.app.json
  - frontend/vite.config.ts
  - frontend/src/app.css
  - frontend/src/main.tsx
  - frontend/src/App.tsx
  - frontend/src/lib/utils.ts
  - frontend/src/api/client.ts
  - frontend/src/api/auth.ts
  - frontend/src/stores/authStore.ts
  - frontend/src/stores/uiStore.ts
  - frontend/src/hooks/useAuth.ts
  - frontend/src/pages/LoginPage.tsx
  - frontend/src/pages/NotFoundPage.tsx
  - frontend/src/components/shared/LoadingSpinner.tsx
  - frontend/components.json
autonomous: true
requirements:
  - DASH-01

must_haves:
  truths:
    - "User can visit /login and see a Sign in with Microsoft button"
    - "Clicking Sign in redirects to /auth/login (backend OAuth)"
    - "Authenticated user visiting / is not redirected to login"
    - "Unauthenticated user visiting / is redirected to /login"
    - "shadcn/ui components render correctly with Tailwind 4 theme"
  artifacts:
    - path: "frontend/src/App.tsx"
      provides: "React Router with protected route layout and public login route"
      contains: "createBrowserRouter"
    - path: "frontend/src/stores/authStore.ts"
      provides: "Zustand auth state: user, mailboxes, isLoading, isAuthenticated"
      contains: "create<AuthState>"
    - path: "frontend/src/api/client.ts"
      provides: "Fetch wrapper with credentials: include and 401 handling"
      contains: "credentials"
    - path: "frontend/src/hooks/useAuth.ts"
      provides: "Auth initialization hook that calls /auth/me on mount"
      contains: "auth/me"
    - path: "frontend/src/pages/LoginPage.tsx"
      provides: "Login page with Microsoft sign-in button"
      contains: "Sign in"
    - path: "frontend/components.json"
      provides: "shadcn/ui configuration"
      contains: "shadcn"
  key_links:
    - from: "frontend/src/App.tsx"
      to: "frontend/src/stores/authStore.ts"
      via: "useAuthStore in ProtectedLayout"
      pattern: "useAuthStore"
    - from: "frontend/src/hooks/useAuth.ts"
      to: "/auth/me"
      via: "apiFetch call on mount"
      pattern: "auth/me"
    - from: "frontend/src/api/client.ts"
      to: "backend auth routes"
      via: "credentials: include for httpOnly cookie"
      pattern: "credentials.*include"
---

<objective>
Set up the frontend foundation: shadcn/ui component library, React Router with protected routes, Zustand auth store, API client with cookie auth, and login page.

Purpose: This plan transforms the placeholder React shell into a functioning SPA with authentication flow, routing, and the component library that all subsequent UI plans depend on.
Output: Working login page, protected route wrapper, auth state management, and shadcn/ui ready for component usage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-frontend-shell-observation-ui/04-RESEARCH.md
@frontend/package.json
@frontend/tsconfig.json
@frontend/tsconfig.app.json
@frontend/vite.config.ts
@frontend/src/App.tsx
@frontend/src/main.tsx
@frontend/src/app.css
@backend/src/auth/routes.ts
@backend/src/config/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, configure shadcn/ui, and set up path aliases</name>
  <files>
    frontend/package.json
    frontend/tsconfig.json
    frontend/tsconfig.app.json
    frontend/vite.config.ts
    frontend/src/app.css
    frontend/components.json
    frontend/src/lib/utils.ts
  </files>
  <action>
1. Install all frontend dependencies in one command:
   ```
   cd frontend && npm install react-router @tanstack/react-query @tanstack/react-table zustand socket.io-client recharts react-is@19.0.0 lucide-react date-fns
   ```

2. Add npm overrides to frontend/package.json for recharts React 19 compatibility:
   ```json
   "overrides": {
     "react-is": "$react-is"
   }
   ```
   Then run `npm install` again to rebuild lockfile with overrides.

3. Install @types/node as a devDependency for path.resolve in vite config:
   ```
   cd frontend && npm install -D @types/node
   ```

4. Configure path aliases in tsconfig.app.json -- add `baseUrl` and `paths`:
   ```json
   "baseUrl": ".",
   "paths": {
     "@/*": ["./src/*"]
   }
   ```

5. Update vite.config.ts to add resolve.alias for `@/` mapping to `./src/`:
   ```typescript
   import path from 'node:path';
   // In defineConfig:
   resolve: {
     alias: {
       '@': path.resolve(__dirname, './src'),
     },
   },
   ```

6. Run `npx shadcn@latest init` in the frontend directory. When prompted:
   - Style: new-york (the only style for 2025+)
   - Base color: neutral (or zinc -- either works)
   - CSS variables: yes
   This will update app.css with theme variables and create components.json and src/lib/utils.ts.

7. After shadcn init, add all needed UI components in one command:
   ```
   cd frontend && npx shadcn@latest add button card table badge separator dropdown-menu switch select skeleton sonner tooltip sidebar chart avatar input scroll-area
   ```

8. Verify the build succeeds: `cd frontend && npx tsc -b && npx vite build`
  </action>
  <verify>
    - `cd frontend && npx tsc -b` compiles without errors
    - `cd frontend && npx vite build` produces dist/ output
    - `ls frontend/src/components/ui/` shows button.tsx, card.tsx, table.tsx, etc.
    - `ls frontend/src/lib/utils.ts` exists
    - `cat frontend/components.json` shows valid shadcn config
  </verify>
  <done>
    - All frontend dependencies installed (react-router, @tanstack/react-query, zustand, socket.io-client, recharts, lucide-react, date-fns)
    - Path alias @/ resolves to src/ in both TypeScript and Vite
    - shadcn/ui initialized with new-york style and Tailwind v4
    - All 15 shadcn components added to frontend/src/components/ui/
    - TypeScript compiles and Vite builds successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth store, API client, login page, and protected router</name>
  <files>
    frontend/src/api/client.ts
    frontend/src/api/auth.ts
    frontend/src/stores/authStore.ts
    frontend/src/stores/uiStore.ts
    frontend/src/hooks/useAuth.ts
    frontend/src/pages/LoginPage.tsx
    frontend/src/pages/NotFoundPage.tsx
    frontend/src/components/shared/LoadingSpinner.tsx
    frontend/src/App.tsx
    frontend/src/main.tsx
  </files>
  <action>
1. Create `frontend/src/api/client.ts` -- fetch wrapper with credentials: 'include' for httpOnly cookie auth. On 401 response, redirect to /login. Base paths: /api for API routes, /auth for auth routes. Do NOT use axios (project uses native fetch). Follow the pattern from research:
   ```typescript
   async function apiFetch<T>(path: string, options?: RequestInit): Promise<T>
   ```
   The path parameter handles both /api/* and /auth/* prefixes directly (e.g., apiFetch('/auth/me') calls /auth/me, apiFetch('/dashboard/stats') calls /api/dashboard/stats). Make the function smart about prefixing: if path starts with /auth, use it as-is; otherwise prepend /api.

2. Create `frontend/src/api/auth.ts` -- auth API functions:
   - `fetchCurrentUser()` calls GET /auth/me, returns user + mailboxes
   - `logout()` calls POST /auth/logout

3. Create `frontend/src/stores/authStore.ts` using Zustand v5:
   ```typescript
   interface AuthState {
     user: User | null;
     mailboxes: MailboxInfo[];
     isLoading: boolean;
     isAuthenticated: boolean;
     setAuth: (user: User, mailboxes: MailboxInfo[]) => void;
     clearAuth: () => void;
     setLoading: (loading: boolean) => void;
   }
   ```
   User type: { id: string; email: string; displayName: string; role: 'admin' | 'user'; preferences: { automationPaused: boolean } }
   MailboxInfo type: { id: string; email: string; displayName: string; isConnected: boolean }

4. Create `frontend/src/stores/uiStore.ts` using Zustand v5:
   ```typescript
   interface UiState {
     sidebarCollapsed: boolean;
     selectedMailboxId: string | null;  // null = aggregate view
     toggleSidebar: () => void;
     setSelectedMailbox: (id: string | null) => void;
   }
   ```

5. Create `frontend/src/hooks/useAuth.ts` -- initialization hook that:
   - Calls fetchCurrentUser() on mount
   - On success: calls authStore.setAuth(user, mailboxes)
   - On error (401): calls authStore.clearAuth()
   - Returns { isLoading, isAuthenticated, user, mailboxes, logout }

6. Create `frontend/src/components/shared/LoadingSpinner.tsx` -- centered spinner using Tailwind animate-spin.

7. Create `frontend/src/pages/LoginPage.tsx` -- centered card with:
   - MSEDB logo/title
   - "Sign in with Microsoft" button that navigates to /auth/login (full page redirect, not fetch)
   - If already authenticated, redirect to /
   - Use shadcn Button component

8. Create `frontend/src/pages/NotFoundPage.tsx` -- simple 404 page with link back to /.

9. Rewrite `frontend/src/App.tsx` with React Router v7:
   - Import from 'react-router' (NOT react-router-dom)
   - createBrowserRouter with routes:
     - /login -> LoginPage
     - / -> ProtectedLayout with children:
       - / -> placeholder DashboardPage (just an h1 "Dashboard" for now)
       - /activity -> placeholder (h1 "Email Activity")
       - /patterns -> placeholder ComingSoon
       - /rules -> placeholder ComingSoon
       - /staging -> placeholder ComingSoon
       - /audit -> placeholder ComingSoon
       - /settings -> placeholder ComingSoon
     - * -> NotFoundPage
   - ProtectedLayout component checks authStore.isAuthenticated. If loading, show LoadingSpinner. If not authenticated, Navigate to /login. If authenticated, render Outlet (no AppShell yet -- that's Plan 02).
   - Wrap RouterProvider in QueryClientProvider from @tanstack/react-query

10. Update `frontend/src/main.tsx` to render App (it should already, but verify it uses createRoot properly).

11. Verify: `cd frontend && npx tsc -b && npx vite build`
  </action>
  <verify>
    - `cd frontend && npx tsc -b` compiles without errors
    - `cd frontend && npx vite build` produces dist/ output
    - All files exist: api/client.ts, api/auth.ts, stores/authStore.ts, stores/uiStore.ts, hooks/useAuth.ts, pages/LoginPage.tsx, pages/NotFoundPage.tsx, components/shared/LoadingSpinner.tsx, App.tsx
  </verify>
  <done>
    - API client sends credentials: include on all requests and redirects to /login on 401
    - Auth store manages user, mailboxes, loading state via Zustand
    - useAuth hook initializes auth state from /auth/me on mount
    - Login page renders "Sign in with Microsoft" button redirecting to /auth/login
    - React Router v7 has all route placeholders with ProtectedLayout guarding authenticated routes
    - QueryClientProvider wraps the app for TanStack Query usage in Plan 02/03
    - TypeScript compiles and Vite builds successfully
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc -b` passes (zero errors)
- `cd frontend && npx vite build` produces dist/ directory
- frontend/src/components/ui/ contains shadcn components (button, card, table, badge, etc.)
- frontend/src/App.tsx contains createBrowserRouter with /login and protected routes
- frontend/src/stores/authStore.ts exports useAuthStore
- frontend/src/api/client.ts uses credentials: 'include'
</verification>

<success_criteria>
- shadcn/ui initialized and all 15 components available
- Path alias @/ working in TypeScript and Vite
- Login page renders with Microsoft sign-in button
- Protected routes redirect unauthenticated users to /login
- Auth store initializes from /auth/me endpoint
- All route placeholders present for future pages
- TypeScript compiles cleanly and Vite builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-shell-observation-ui/04-01-SUMMARY.md`
</output>
