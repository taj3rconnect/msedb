---
phase: 08-outlook-add-in
plan: 02
type: execute
wave: 2
depends_on:
  - "08-01"
files_modified:
  - addin/src/taskpane/taskpane.tsx
  - addin/src/taskpane/App.tsx
  - addin/src/taskpane/components/SenderActions.tsx
  - addin/src/taskpane/components/DomainActions.tsx
  - addin/src/taskpane/components/StatusBanner.tsx
  - addin/src/taskpane/components/AuthStatus.tsx
  - addin/src/taskpane/app.css
  - addin/src/commands/commands.ts
autonomous: true
requirements:
  - PLUG-02
  - PLUG-03

must_haves:
  truths:
    - "User opens taskpane and sees the current email's sender name, email, and domain"
    - "User can click 'Never Delete' to whitelist a sender, and the action syncs to the MSEDB backend whitelist"
    - "User can click 'Always Delete' to blacklist a sender, and a delete rule is created in the MSEDB backend"
    - "User can whitelist or blacklist an entire domain (e.g., @newsletter.com) with the same workflow"
    - "User sees success/error feedback after each action"
    - "Add-in resolves the correct MSEDB mailbox by matching Office.context.mailbox.userProfile.emailAddress"
  artifacts:
    - path: "addin/src/taskpane/App.tsx"
      provides: "Main taskpane UI with sender info display, mailbox resolution, and action dispatch"
      min_lines: 80
    - path: "addin/src/taskpane/components/SenderActions.tsx"
      provides: "Whitelist/blacklist buttons for the current email sender"
      contains: "handleAction"
    - path: "addin/src/taskpane/components/DomainActions.tsx"
      provides: "Whitelist/blacklist buttons for the current email sender's domain"
      contains: "handleAction"
    - path: "addin/src/taskpane/components/StatusBanner.tsx"
      provides: "Success/error feedback banner with auto-dismiss"
      contains: "status"
    - path: "addin/src/taskpane/components/AuthStatus.tsx"
      provides: "SSO authentication status display with retry capability"
      contains: "isAuthenticated"
    - path: "addin/src/taskpane/app.css"
      provides: "Tailwind CSS imports and add-in-specific styles for narrow taskpane"
      contains: "@import"
  key_links:
    - from: "addin/src/taskpane/App.tsx"
      to: "addin/src/api/backendClient.ts"
      via: "calls getMailboxes, updateWhitelist, createRule"
      pattern: "getMailboxes|updateWhitelist|createRule"
    - from: "addin/src/taskpane/App.tsx"
      to: "Office.context.mailbox.item"
      via: "reads sender info from current email"
      pattern: "Office\\.context\\.mailbox\\.item"
    - from: "addin/src/taskpane/components/SenderActions.tsx"
      to: "addin/src/taskpane/App.tsx"
      via: "receives onAction callback prop"
      pattern: "onAction"
    - from: "addin/src/taskpane/components/DomainActions.tsx"
      to: "addin/src/taskpane/App.tsx"
      via: "receives onAction callback prop"
      pattern: "onAction"
---

<objective>
Build the taskpane UI with sender/domain whitelist and blacklist actions that sync to the MSEDB backend.

Purpose: This is the user-facing feature -- the reason the add-in exists. Users mark senders/domains as "never delete" (whitelist) or "always delete" (blacklist) directly from Outlook, and the actions take effect in the MSEDB automation system within seconds.
Output: Complete taskpane with sender info display, whitelist/blacklist buttons for both sender and domain levels, success/error feedback, and mailbox resolution.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-outlook-add-in/08-RESEARCH.md
@.planning/phases/08-outlook-add-in/08-01-SUMMARY.md
@addin/src/auth/authHelper.ts
@addin/src/api/backendClient.ts
@addin/src/types/index.ts
@addin/webpack.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build taskpane App component with sender/domain actions and mailbox resolution</name>
  <files>
    addin/src/taskpane/taskpane.tsx
    addin/src/taskpane/App.tsx
    addin/src/taskpane/components/SenderActions.tsx
    addin/src/taskpane/components/DomainActions.tsx
    addin/src/taskpane/components/StatusBanner.tsx
    addin/src/taskpane/components/AuthStatus.tsx
    addin/src/taskpane/app.css
  </files>
  <action>
    **addin/src/taskpane/app.css:**
    - Import Tailwind via `@import "tailwindcss";`
    - Add base styles for the taskpane: body margin 0, font-family system-ui, background white
    - Add utility class `.taskpane-container` with max-width 450px, padding 16px, margin 0 auto
    - The taskpane is narrow (320-450px) -- all components must be designed for this width

    **addin/src/taskpane/taskpane.tsx:**
    - Update the placeholder from Plan 01 to render the full App component
    - Import `./app.css` for Tailwind
    - Import App from `./App`
    - Gate behind `Office.onReady()` then `createRoot(document.getElementById('root')!).render(<App />)`

    **addin/src/taskpane/App.tsx:**
    Main orchestrator component. Manages state for sender info, mailbox resolution, auth status, and action dispatch.

    State:
    - `sender: SenderInfo | null` -- current email's sender (from Office.context.mailbox.item.from)
    - `mailboxId: string | null` -- resolved MSEDB mailbox ID
    - `isAuthReady: boolean` -- whether SSO auth succeeded
    - `authError: string | null` -- auth failure message
    - `status: { type: 'success' | 'error'; message: string } | null` -- action feedback
    - `loading: boolean` -- action in progress

    On mount (useEffect):
    1. Read sender info from `Office.context.mailbox.item`:
       - `const item = Office.context.mailbox.item;`
       - If item and item.from: extract email (lowercase), displayName, domain (email.split('@')[1])
       - Set sender state
    2. Authenticate and resolve mailbox:
       - Call `checkNaaSupport()` from authHelper -- if not supported, set authError "NAA not supported on this version of Office"
       - Try `getAccessToken()` -- if succeeds, set isAuthReady true
       - Call `getMailboxes()` from backendClient
       - Match `Office.context.mailbox.userProfile.emailAddress.toLowerCase()` to find the correct mailbox
       - Set mailboxId from the match
       - If no match found, set authError "No matching mailbox found in MSEDB for {email}"

    Action handler -- `handleAction(action: WhitelistAction, scope: ActionScope)`:
    - Guard: if !sender or !mailboxId, return
    - Set loading true, clear status
    - Determine value: scope === 'sender' ? sender.email : sender.domain
    - If action === 'whitelist':
      1. GET current whitelist via `getWhitelist(mailboxId)`
      2. Compute updated list: add value to senders[] or domains[] (deduplicate with Set)
      3. PUT updated whitelist via `updateWhitelist(mailboxId, { [scope === 'sender' ? 'senders' : 'domains']: updatedList })`
      4. Set status success: "Added {value} to whitelist (never delete)"
    - If action === 'blacklist':
      1. POST new rule via `createRule({ mailboxId, name: 'Always delete: {value}', conditions: scope === 'sender' ? { senderEmail: value } : { senderDomain: value }, actions: [{ actionType: 'delete' }] })`
      2. Set status success: "Created delete rule for {value}"
    - On error: set status error with message
    - Finally: set loading false

    Render:
    - Wrap in `.taskpane-container`
    - Header: "MSEDB Email Manager" with a small shield icon (from lucide-react: Shield)
    - If authError: render `<AuthStatus error={authError} onRetry={retryAuth} />`
    - If !sender: render "Select an email to use MSEDB actions"
    - If sender:
      - Sender info card: display name, email, @domain -- use Tailwind bg-gray-50 rounded p-3
      - `<SenderActions sender={sender} onAction={handleAction} loading={loading} disabled={!mailboxId} />`
      - `<DomainActions domain={sender.domain} onAction={handleAction} loading={loading} disabled={!mailboxId} />`
    - If status: render `<StatusBanner status={status} onDismiss={() => setStatus(null)} />`

    **addin/src/taskpane/components/SenderActions.tsx:**
    - Props: `{ sender: SenderInfo; onAction: (action: WhitelistAction, scope: ActionScope) => void; loading: boolean; disabled: boolean }`
    - Render section with heading "Sender Actions"
    - Two buttons stacked vertically (full width for narrow taskpane):
      - "Never Delete Sender" (whitelist) -- green outline button with ShieldCheck icon from lucide-react
      - "Always Delete Sender" (blacklist) -- red outline button with Trash2 icon from lucide-react
    - Buttons disabled when loading or disabled
    - Show sender email below heading as context
    - Use Tailwind classes: `w-full py-2 px-4 rounded-lg border text-sm font-medium` with appropriate color variants
    - Green button: `border-green-500 text-green-700 hover:bg-green-50`
    - Red button: `border-red-500 text-red-700 hover:bg-red-50`
    - Disabled state: `opacity-50 cursor-not-allowed`

    **addin/src/taskpane/components/DomainActions.tsx:**
    - Same structure as SenderActions but for domain-level actions
    - Props: `{ domain: string; onAction: (action: WhitelistAction, scope: ActionScope) => void; loading: boolean; disabled: boolean }`
    - Heading "Domain Actions" with subtext "@{domain}"
    - "Never Delete Domain" (whitelist) -- green outline, Globe icon from lucide-react
    - "Always Delete Domain" (blacklist) -- red outline, Trash2 icon from lucide-react
    - Same styling conventions as SenderActions

    **addin/src/taskpane/components/StatusBanner.tsx:**
    - Props: `{ status: { type: 'success' | 'error'; message: string }; onDismiss: () => void }`
    - Render a banner at the bottom of the taskpane:
      - Success: green background (bg-green-50 border-green-200 text-green-800) with CheckCircle icon
      - Error: red background (bg-red-50 border-red-200 text-red-800) with XCircle icon
    - X button to dismiss
    - Auto-dismiss after 5 seconds via useEffect with setTimeout (clear on unmount)

    **addin/src/taskpane/components/AuthStatus.tsx:**
    - Props: `{ error: string; onRetry: () => void }`
    - Render an error state card:
      - AlertTriangle icon from lucide-react
      - Error message text
      - "Retry" button that calls onRetry
    - Yellow/amber styling: bg-amber-50 border-amber-200 text-amber-800

    **Style consistency with MSEDB dashboard:**
    - Use the same color palette: blue-600 primary, green for whitelist/positive, red for blacklist/destructive
    - Use system font stack matching Tailwind defaults
    - Rounded corners (rounded-lg), subtle borders, consistent spacing (space-y-4 between sections)
    - The taskpane is NOT a miniature dashboard -- it's a focused action panel
  </action>
  <verify>
    1. `cd /home/admin/claude/MSEDB/addin && npm run build` compiles successfully with all components
    2. `ls addin/dist/taskpane.js` exists and includes App, SenderActions, DomainActions
    3. `grep "handleAction" addin/src/taskpane/App.tsx` confirms action handler exists
    4. `grep "Office.context.mailbox.item" addin/src/taskpane/App.tsx` confirms sender reading
    5. `grep "getMailboxes" addin/src/taskpane/App.tsx` confirms mailbox resolution
    6. `grep "updateWhitelist\|createRule" addin/src/taskpane/App.tsx` confirms backend API calls
  </verify>
  <done>
    Taskpane renders sender info from current email, provides whitelist/blacklist buttons for both sender and domain levels, resolves the correct MSEDB mailbox via /auth/me, syncs actions to the backend (whitelist PUT for "never delete", rule POST for "always delete"), and shows success/error feedback. Build completes without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ribbon commands and add Office.context.mailbox.item change handler</name>
  <files>
    addin/src/commands/commands.ts
    addin/src/taskpane/App.tsx
  </files>
  <action>
    **addin/src/commands/commands.ts:**
    - Update the placeholder from Plan 01
    - Keep `Office.onReady()` initialization
    - The commands.ts file handles ExecuteFunction actions from ribbon buttons
    - Since the primary UX is the taskpane (ShowTaskpane action), commands.ts remains minimal
    - Add a no-op handler for potential future function commands:
      ```
      function noop(event: Office.AddinCommands.Event) { event.completed(); }
      Office.actions.associate("noop", noop);
      ```
    - This is intentionally minimal -- the ribbon button uses ShowTaskpane (not ExecuteFunction), so commands.ts is only needed as the FunctionFile referenced in the manifest

    **addin/src/taskpane/App.tsx:**
    - Add an `Office.context.mailbox.addHandlerAsync` for `Office.EventType.ItemChanged` event
    - When the user selects a different email in Outlook, re-read sender info from `Office.context.mailbox.item`
    - Update the sender state accordingly
    - Clear any existing status banner when the selected email changes
    - Register the handler in the useEffect mount, and remove it in the cleanup function via `Office.context.mailbox.removeHandlerAsync`
    - This ensures the taskpane stays in sync as the user navigates between emails

    **Important edge cases to handle in App.tsx:**
    - `Office.context.mailbox.item` may be null if no email is selected -- show "Select an email" message
    - `item.from` may be undefined in some edge cases (draft emails, calendar items) -- handle gracefully
    - If the user switches to a compose view, the add-in should show "This add-in works when reading emails"
    - Mailbox ID resolution should only happen once (cache in state), not on every email selection change
  </action>
  <verify>
    1. `cd /home/admin/claude/MSEDB/addin && npm run build` compiles successfully
    2. `grep "ItemChanged\|addHandlerAsync" addin/src/taskpane/App.tsx` confirms item change handler
    3. `grep "event.completed" addin/src/commands/commands.ts` confirms command handler pattern
    4. `grep "removeHandlerAsync" addin/src/taskpane/App.tsx` confirms cleanup on unmount
  </verify>
  <done>
    Ribbon commands file serves as the manifest FunctionFile. Taskpane updates sender info when the user selects a different email via ItemChanged event handler. Edge cases handled: no email selected, non-message items, compose view. Mailbox ID cached after first resolution.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/admin/claude/MSEDB/addin && npm run build` -- full add-in build with all feature components
2. `cd /home/admin/claude/MSEDB/backend && npx tsc --noEmit` -- backend still compiles
3. All 4 action flows are wired: sender whitelist, sender blacklist, domain whitelist, domain blacklist
4. Taskpane reads sender from Office.context.mailbox.item.from
5. Mailbox resolved by matching Office.context.mailbox.userProfile.emailAddress to /auth/me response
6. ItemChanged handler keeps taskpane in sync with email selection
</verification>

<success_criteria>
- Taskpane shows sender name, email, and domain from the currently selected email
- Four action buttons work: Never Delete Sender, Always Delete Sender, Never Delete Domain, Always Delete Domain
- Whitelist actions call PUT /api/mailboxes/:id/whitelist with updated senders/domains array
- Blacklist actions call POST /api/rules to create a delete rule
- Success/error feedback displayed via StatusBanner with auto-dismiss
- Email selection changes update the taskpane via ItemChanged handler
- Build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-outlook-add-in/08-02-SUMMARY.md`
</output>
